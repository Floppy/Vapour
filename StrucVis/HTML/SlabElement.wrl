#VRML V2.0 utf8
#=============---
# Arup Simulation Visualisation System
#-------------
# Copyright 2002 Vapour Technology Ltd.
#
# SlabElement.wrl
# 19/03/2002 - James Smith
#
# $Id: SlabElement.wrl,v 1.11 2002/03/26 23:45:11 vap-james Exp $

PROTO SlabElement [
   eventIn MFColor  set_colours
   eventIn MFInt32  set_cracks
   eventIn MFVec3f  set_nodes
   eventIn SFBool   set_visible
   field   MFColor  colours     [ 1 1 1, 1 1 1, 1 1 1, 1 1 1, 1 1 1, 1 1 1, 1 1 1, 1 1 1, 1 1 1]
   field   MFInt32  cracks      [ 0 0 0 0 0 0 0 0 0 ]
   field   MFString description ["ID:" "Group:" "Temperature:"]
   field   MFVec3f  nodes       [ 0.5 0 0.5, 0 0 0.5, -0.5 0 0.5, -0.5 0 0, -0.5 0 -0.5, 0 0 -0.5, 0.5 0 -0.5, , 0.5 0 0, 0 0 0]
   field   SFFloat  thickness   1
   eventOut MFString description_changed
]
{

   PROTO Crack [
      field SFVec3f size 0.1 0.2 0.1
      exposedField SFInt32 type 0
      exposedField SFVec3f translation 0 0 0
   ]
   {
      Transform {
         translation IS translation
         children [
            Switch {
               whichChoice IS type
               choice [
                  Group {}
                  Shape {
                     appearance Appearance {
                        material Material {
                           diffuseColor 1 1 0
                        }
                     }
                     geometry DEF GEOM Box {
                        size IS size
                     }
                  }
                  Shape {
                     appearance Appearance {
                        material Material {
                           diffuseColor 1 0 0
                        }
                     }
                     geometry USE GEOM
                  }
                  Shape {
                     appearance Appearance {
                        material Material {
                           diffuseColor 0 1 1
                        }
                     }
                     geometry USE GEOM
                  }
               ]
            }
         ]
      }
   }

   Group {
      children [
         DEF SENSOR TouchSensor {}
         DEF SLAB Shape {
            appearance Appearance {
               material DEF SLABMATERIAL Material {
                  #transparency 0.5
                  diffuseColor 0.5 0.5 0.5
               }
            }
            geometry IndexedFaceSet {
               coord DEF COORDS Coordinate {}
               color DEF COLOURS Color {}
               colorPerVertex TRUE
               solid FALSE
               coordIndex [
                  0 28 32 4 -1
                  4 32 12 8 -1
                  32 20 16 12 -1
                  28 24 20 32 -1
                  3 7 35 31 -1
                  7 11 15 35 -1
                  35 15 19 23 -1
                  31 35 23 27 -1
                  0 4 5 1 -1
                  2 6 7 3 -1
                  4 8 9 5 -1
                  6 10 11 7 -1
                  8 12 13 9 -1
                  10 14 15 11 -1
                  12 16 17 13 -1
                  14 18 19 15 -1
                  16 20 21 17 -1
                  18 22 23 19 -1
                  20 24 25 21 -1
                  22 26 27 23 -1
                  24 28 29 25 -1
                  26 30 31 27 -1
                  28 0 1 29 -1
                  30 2 3 31 -1
               ]
            }
         }
         DEF STEEL Shape {
            appearance Appearance {
               material DEF STEELMATERIAL Material {
                  shininess 1
                  diffuseColor 0.75 0.75 0.75
               }
            }
            geometry IndexedFaceSet {
               coord USE COORDS
               #color USE COLOURS
               #colorPerVertex TRUE
               solid TRUE
               coordIndex [
                  #1 29 33 5 -1
                  #5 33 13 9 -1
                  #33 21 17 13 -1
                  #29 25 21 33 -1
                  #2 6 34 30 -1
                  #6 10 14 34 -1
                  #34 14 18 22 -1
                  #30 34 22 26 -1
                  1 5 6 2 -1
                  5 9 10 6 -1
                  9 13 14 10 -1
                  13 17 18 14 -1
                  17 21 22 18 -1
                  21 25 26 22 -1
                  25 29 30 26 -1
                  29 1 2 30 -1
               ]
            }
         }
         Group {
            children [
               DEF CRACK1 Crack {}
               DEF CRACK2 Crack {}
               DEF CRACK3 Crack {}
               DEF CRACK4 Crack {}
               DEF CRACK5 Crack {}
               DEF CRACK6 Crack {}
               DEF CRACK7 Crack {}
               DEF CRACK8 Crack {}
               DEF CRACK9 Crack {}
            ]
         }
      ]
   }
   DEF SCRIPT Script {
      directOutput TRUE
      mustEvaluate TRUE
      eventIn MFColor set_colours IS set_colours
      eventIn MFInt32 set_cracks IS set_cracks
      eventIn MFVec3f set_nodes IS set_nodes
      eventIn SFBool  set_visible IS set_visible
      eventIn SFBool  set_mouseOver
      field MFColor colours IS colours
      field MFInt32 cracks IS cracks
      field MFString description IS description
      field SFFloat thickness IS thickness
      field MFVec3f nodes  IS nodes
      field MFVec3f points []
      field SFNode  coordNode USE COORDS
      field SFNode  colourNode USE COLOURS
      field SFNode  steelmaterial USE STEELMATERIAL
      field SFNode  slabmaterial USE SLABMATERIAL
      field SFNode  crack1 USE CRACK1
      field SFNode  crack2 USE CRACK2
      field SFNode  crack3 USE CRACK3
      field SFNode  crack4 USE CRACK4
      field SFNode  crack5 USE CRACK5
      field SFNode  crack6 USE CRACK6
      field SFNode  crack7 USE CRACK7
      field SFNode  crack8 USE CRACK8
      field SFNode  crack9 USE CRACK9
      eventOut MFString description_changed IS description_changed
      url "javascript:
         function initialize() {
            // Create points
            points[0]  = new SFVec3f(0,thickness,0);
            points[1]  = new SFVec3f(0,thickness/2 + thickness/20,0);
            points[2]  = new SFVec3f(0,thickness/2 - thickness/20,0);
            points[3]  = new SFVec3f(0,0,0);
            // Calculate initial node positions and colours
            update_nodes(nodes);
            update_colours(colours);
            update_cracks(cracks);
         }
         function set_colours(value,time) {
            update_colours(value);
         }
         function update_colours(colourset) {
            for (i=0; i<9; i++) {
               for (j=0; j<4; j++) {
                  colourNode.color[(i*4) + j] = colourset[i];
               }
            }
         }
         function set_nodes(value,time) {
            update_nodes(value);
         }
         function update_nodes(nodeset) {
            // Set node locations
            for (i=0; i<9; i++) {
               for (j=0; j<4; j++) {
                  coordNode.point[(i*4) + j] = nodeset[i].add(points[j]);
               }
            }
            // Set crack locations
            crack1.translation = coordNode.point[32].add(coordNode.point[0].subtract(coordNode.point[32]).multiply(0.5));
            crack2.translation = coordNode.point[32].add(coordNode.point[4].subtract(coordNode.point[32]).multiply(0.5));
            crack3.translation = coordNode.point[32].add(coordNode.point[8].subtract(coordNode.point[32]).multiply(0.5));
            crack4.translation = coordNode.point[32].add(coordNode.point[12].subtract(coordNode.point[32]).multiply(0.5));
            crack5.translation = coordNode.point[32].add(coordNode.point[16].subtract(coordNode.point[32]).multiply(0.5));
            crack6.translation = coordNode.point[32].add(coordNode.point[20].subtract(coordNode.point[32]).multiply(0.5));
            crack7.translation = coordNode.point[32].add(coordNode.point[24].subtract(coordNode.point[32]).multiply(0.5));
            crack8.translation = coordNode.point[32].add(coordNode.point[28].subtract(coordNode.point[32]).multiply(0.5));
            crack9.translation = coordNode.point[32].add(coordNode.point[32].subtract(coordNode.point[32]).multiply(0.5));
         }
         function set_cracks(value,time) {
            update_cracks(value);
         }
         function update_cracks(crack_types) {
            crack1.type = crack_types[0];
            crack2.type = crack_types[1];
            crack3.type = crack_types[2];
            crack4.type = crack_types[3];
            crack5.type = crack_types[4];
            crack6.type = crack_types[5];
            crack7.type = crack_types[6];
            crack8.type = crack_types[7];
            crack9.type = crack_types[8];
         }
         function set_visible(value,time) {
            if (value == true) {
               steelmaterial.transparency = 0;
               slabmaterial.transparency = 0;
            }
            else {
               steelmaterial.transparency = 0.9;
               slabmaterial.transparency = 0.9;
            }
         }
         function set_mouseOver(value,time) {
            if (value) {
               description_changed = description;
            }
            else {
               description_changed = new MFString();
            }
         }
      "
   }
   ROUTE SENSOR.isOver TO SCRIPT.set_mouseOver
}

SlabElement {}